bundle agent user {
  methods: 
    "idealcoder"
      usebundle => user_present('{
        "user": "idealcoder",
        "groups": ["sudo", "sshuser"],
        "ssh_keys": ["ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDKu7k5izwBCa8YNqrzmtCNwWyFlY0GLQu9lRgDqE5INzXed0AKodeS4ihBvbO+hwKNLnGhBxKlqEJB8M9I+ElC4qQeCQBtrcGzFG02QGyJVriPXSiLCybLZFQISauBEzReHb0+UC1KZSdVh1dnVw4OHmhpM3L4fIOF3b4WUHSHyp/uHLtcYcfpZesi1EKFXzFRWfjUrqu2ie4OhX0PAs0i4ZZOuIdbK6pw4JmRyei57afpVKCbUxPQ6vxnXXXitL8I7D8nNsXIVYhfQlvBLSc8EN9V4lVWiloPBnmn0pYuZKsUPn3C4Vhgk1bgOEvHXiOvokzXINcVgTfzxPbzIKKHDDkzaz2f4dKxe4FL2FkjU3xPpf6Ns2ygiqbiIrcBw/aveK2BZMP23Ei+AxLlBrtx138LjQpnytoVOii5ImsGilyrIiMnJS103MclzBaNQEcW2h8v/bkSoy9pDMxgN9GR6igaLIy+R5dzD1u8b7XSGcNhYMV+XvN6Sgf48ew5T/WKbCUvQx0Kzt9bXC3UJ6jS4LuvKyxQMN9eZ/DwVOrY0VpZP5LD7zRSSnn1APKIP0rmDQq7g/wkOhgYJqr9UcEJt+jzuNqpj9Qkv0FoYI+F/nJpzhc1wq4T+Wu8uM91IxmgRWF7WNZ4ldXN2XVPhPMR6tUPc0pkfkK/bSMkPm+B/w== idealcoder@redguppy"]
      }');
}

bundle agent user_present(data) {
  vars:
    "user"     string => "$(data[user])";
    "groups"   slist  => getvalues("data[groups]");
    "ssh_keys" slist  => getvalues("data[ssh_keys]");

  classes:
    "user_exists" expression => userexists("$(user)");

  methods:
    "groups_present"
      usebundle => group_present("$(groups)"),
      handle => "groups_present";

  commands:
    !user_exists::
      "/usr/sbin/adduser"
        arglist => { "--quiet"
	        , "--shell /bin/zsh"
		, "--add_extra_groups"
		, "--disabled-password"
		, "--gecos ''"
		, "$(user)"},
	classes => if_ok("user_exists");

      "/usr/sbin/addgroup"
	depends_on => {"groups_present"},
        arglist => { "--quiet"
	        , "$(user)"
		, "$(groups)"};

  files:
    user_exists::
      # assumes home directory location
      "/home/$(user)/.ssh/authorized_keys"
        create => "true",
        edit_line => lines_present("$(ssh_keys)");

  reports:
    "user $(user)";
    "groups $(groups)";
    "ssh_keys $(ssh_keys)";
}

bundle agent group_present(group) {
  classes:
   "group_exists" expression => groupexists("$(group)");

  commands:
    !group_exists::
      "/usr/sbin/addgroup --quiet $(group)";
}
